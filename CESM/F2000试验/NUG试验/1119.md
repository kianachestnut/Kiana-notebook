你好！欢迎来到大气科学的大家庭！研一刚开始接触CESM确实会觉得千头万绪，不用担心。

复现Lu et al. (2023) 这篇文章（E3SMv1）在CESM中确实是一个挑战，因为E3SM虽然源自CESM，但两者已经分家了。**这篇文章的核心改动（将Freitas plume-rise model耦合进模式）通常涉及到源代码（Fortran）的修改，不仅仅是改改csh脚本就能实现的。**

但是，既然你的任务是“搭建复现的框架”，特别是**NUG（Nudged，松弛逼近/同化）**部分，我可以手把手教你如何修改脚本来建立这个实验配置。

以下是为你准备的**保姆级教程**。

### 第一步：准备工作（非常重要）

在运行脚本前，你心里要清楚复现这篇文章需要的三个核心要素：

1.  **源代码 (SourceMods)**: 文章说 *"We incorporate an interactive fire plume-rise model..."*，这意味着他们改了模型代码。你需要在你的案例目录里找到 `SourceMods/src.cam`，把你复现或从作者GitHub下载的Fortran代码放进去。
2.  **强迫数据 (Nudging Data)**: NUG实验需要气象再分析数据（如MERRA2）。你的脚本里已经有雏形了，但被注释掉了。你需要确认服务器上 `/share/home/minghuai/Liuym/DATA/MERRA2/` 这个路径下是否有数据，以及 `filenames_list` 文件是否存在。
3.  **路径规则**: 严格遵守师姐的指示，不改动 `yliang` 相关的路径。

### 第二步：修改后的脚本 (`run_Lu2023_NUG.csh`)

我基于你的 `F2000_default.csh` 进行了修改。你可以直接复制保存为新文件（例如 `run_NUG.csh`）。

**主要修改点说明（看代码注释）：**
1.  **CASE名字**: 改为了 `F2000_Lu2023_NUG`，方便区分。
2.  **Nudging设置**: 在 `user_nl_cam` 中开启了 Nudging 开关，并且根据文章设置，**只同化 U 和 V（水平风场）**，松弛时间设置为 **6小时**。
3.  **SourceMods链接**: 增加了一段代码，自动把你的源代码链接过去（如果你有的话）。

```csh
#!/bin/csh -fx

# ====================================================================
# 用户设置部分 (User Defined)
# ====================================================================

# 1. 定义机器和编译器环境
setenv MACH hpcc
setenv CCSMTAG CESM2-release-2.1.0

# 2. 定义不能动的公共路径 (师姐强调的部分)
setenv CCSMROOT /share/home/minghuai/yliang/model/$CCSMTAG
setenv DATADIR  /share/home/minghuai/yliang/model/CESM_INPUT

# 3. 定义你自己的路径 (需要修改这里确保是你自己的目录)
# 注意：lxyyy 应该是你的用户名或者目录名，请确认
setenv MY_ROOT  /share/home/ywliu/lxyyy  
setenv CIME_OUTPUT_ROOT $MY_ROOT/scratch/runout

# 4. 定义Case名字 (建议包含实验特征)
# NUG代表Nudging实验
setenv CASE    F2000_Lu2023_NUG
setenv CASEROOT $MY_ROOT/scratch/cesmrun/$CASE
setenv RUNDIR   $CIME_OUTPUT_ROOT/$CASE

# 5. 定义源代码路径 (如果你有改好的Fortran代码，放在这里)
# 如果暂时没有，可以先注释掉 setenv mymodscam 这一行
# setenv mymodscam $MY_ROOT/scripts/mycode/Lu2023_SourceMods

# ====================================================================
# 清理旧Case (慎用，防止手滑删错)
# ====================================================================

if ( -e ${CASEROOT} ) then
    rm -rf $CASEROOT
endif

if ( -e ${RUNDIR} ) then
    rm -rf $RUNDIR
endif

# ====================================================================
# 创建 New Case
# ====================================================================

cd $CCSMROOT/cime/scripts

# 使用 F2000climo (F compset: 强迫海温的大气实验)，这是做气溶胶-气候相互作用的标准配置
./create_newcase --case $CASEROOT --mach $MACH --res f09_f09_mg17 --compset F2000climo \
                 --compiler intel --queue mpi --walltime 01:00 --run-unsupported

# ====================================================================
# 配置环境 (xmlchange)
# ====================================================================

cd $CASEROOT

# 修改运行目录
./xmlchange --file env_build.xml --id EXEROOT --val "${RUNDIR}/bld"
./xmlchange --file env_run.xml   --id RUNDIR  --val "${RUNDIR}/run"

# 输出数据归档设置 (调试阶段可以设为FALSE，正式跑设为TRUE)
./xmlchange --file env_run.xml   --id DOUT_S  --val 'FALSE'

# 设置运行时间
# 文章中NUG实验跑了1年 (2018年)。这里先跑5天测试能不能通。
./xmlchange --file env_run.xml --id RUN_STARTDATE --val '2018-01-01'
./xmlchange --file env_run.xml --id STOP_N        --val '5'
./xmlchange --file env_run.xml --id STOP_OPTION   --val 'ndays'

# 并行核心设置 (参考你的原脚本)
set N = 48
set M = 48

./xmlchange --file env_mach_pes.xml --id NTASKS_ATM --val "$N"
./xmlchange --file env_mach_pes.xml --id NTHRDS_ATM --val '1'
./xmlchange --file env_mach_pes.xml --id ROOTPE_ATM --val '0'
# ... (其他组件保持跟大气一致即可，因为是F case，海洋是数据模式，开销很小)
./xmlchange --file env_mach_pes.xml --id NTASKS_LND --val "$N"
./xmlchange --file env_mach_pes.xml --id NTASKS_ICE --val "$M"
./xmlchange --file env_mach_pes.xml --id NTASKS_OCN --val "$M"
./xmlchange --file env_mach_pes.xml --id NTASKS_CPL --val "$M"
./xmlchange --file env_mach_pes.xml --id NTASKS_GLC --val "$M"
./xmlchange --file env_mach_pes.xml --id NTASKS_ROF --val "$M"
./xmlchange --file env_mach_pes.xml --id NTASKS_WAV --val "$M"
./xmlchange --file env_mach_pes.xml --id NTHRDS_ESP --val '1'

# ====================================================================
# 链接源代码 (SourceMods) - 核心步骤
# ====================================================================
cd $CASEROOT

# 如果你定义了 mymodscam 且文件夹存在，就把代码链过来
if ( $?mymodscam ) then
  if ( -d ${mymodscam} ) then
    echo "Linking SourceMods from ${mymodscam}"
    ln -s ${mymodscam}/* SourceMods/src.cam
  endif
endif

# ====================================================================
# 配置 namelist (Nudging 和 变量输出)
# ====================================================================

# 警告：请确保下面的 met_data_path 和 met_filenames_list 真实存在！
# 如果这些文件不存在，模型会报错直接停掉。

echo "user_nl_cam"
cat <<EOF >! user_nl_cam

! --- 气溶胶与物理包设置 ---
! 文章使用的是 trop_mam4，通常在 xmlchange CAM_CONFIG_OPTS 中设置，
! 但默认的 F2000climo 已经是 MAM4 了。

! --- Nudging (松弛逼近) 设置 ---
! Lu et al. 2023: "U, V components ... nudged to MERRA-2 ... relaxation timescale of 6 hr"
! 这里的设置是开启Nudging的关键

Nudge_Model = .true.
Nudge_Path  = '/share/home/minghuai/Liuym/DATA/MERRA2/CESM/0.9x1.25_32L/'
Nudge_File_Template = '/share/home/ywliu/yhzhang/data/Nudging_filenames/filenames_2000-2024_365.txt'
! 注意：你需要确认上面这个txt文件里是否包含2018年的文件名

ndgs_tau    = 6, 6, 6, 6   ! 松弛时间尺度 6小时
nudge_u     = .true.       ! 同化 U 风
nudge_v     = .true.       ! 同化 V 风
nudge_t     = .false.      ! 文章说: temperatures ... are not nudged
nudge_q     = .false.      ! 文章说: water vapors are not nudged
nudge_ps    = .false.      ! 地面气压通常也不nudging，除非文章特指

! --- 输出变量设置 ---
avgflag_pertape = 'A'     ! A:平均态
nhtfrq          = -24     ! -24: 输出日平均
mfilt           = 30      ! 一个文件存30个时次

! 输出变量列表 (根据文章图表需求添加)
fincl1 = 'PRECT','T','U','V','U10','Q','Z3','PS',
         'AODVIS','AODDUST','AODBC','AODPOM','AODSO4',
         'CLDTOT','CDNUMC','FSNT','FLNT'

! 如果你要复现Plume Rise，你可能需要输出特定的变量
! 例如注入高度等，这取决于你在SourceMods里加了什么变量
! fincl1 = ..., 'PLUME_HEIGHT', ...

! --- 初始场设置 ---
! 保持原脚本的设置，或者根据你的年份修改
&cam_initfiles_nl
bnd_topo = '/share/home/minghuai/yliang/model/CESM_INPUT/atm/cam/topo/fv_0.9x1.25_nc3000_Nsw042_Nrs008_Co060_Fi001_ZR_sgh30_24km_GRNL_c170103.nc'
ncdata   = '/share/home/minghuai/yliang/model/CESM_INPUT/atm/cam/inic/fv/f.e20.FCSD.f09_f09_mg17.cesm2.1-exp002.001.cam.i.2005-01-01-00000_c180801_32L.nc'
/
EOF

# ====================================================================
# 编译和提交
# ====================================================================

cd $CASEROOT
./case.setup

# 如果之前编译过想省时间，可以不加 --clean-all。
# 但因为你可能要加 SourceMods，建议必须 clean-all 重新编译。
./case.build --clean-all

./case.build --skip-provenance-check

./case.submit

date
```

### 第三步：你需要检查和操作的细节

1.  **关于Nudging文件列表 (`filenames_2000-2024_365.txt`)**:
    *   脚本里引用了 `/share/home/ywliu/yhzhang/data/Nudging_filenames/...`。
    *   **请务必去检查这个文件是否存在！** 以及打开它看看里面的文件路径格式是否正确。Nudging 运行最容易崩的地方就是读不到驱动场文件。如果文件里没有2018年的数据，你需要自己制作这个列表文件。

2.  **关于源代码 (SourceMods)**:
    *   这是复现该文章最核心也是最难的一步。CESM默认的 CAM6 代码里，生物质燃烧排放通常是读入预设的垂直廓线（Prescribed vertical profiles）。
    *   Lu et al. (2023) 是把 `Freitas et al. (2007)` 的 1-D plume-rise 模型写进去了。这意味着你需要：
        *   去文章的数据可用性声明（Data Availability Statement）找代码链接，或者去 Github 搜 E3SM 的代码。
        *   找到负责计算排放高度的 Fortran 文件（通常是 `mo_aero_emit.F90` 或者类似名字）。
        *   把修改后的 `.F90` 文件放到你 Case 目录下的 `SourceMods/src.cam/` 里面。
        *   **如果你还没有代码**，运行上面的脚本只会跑一个“默认的 CESM Nudging 实验”，也就是文章中的 **NUG_CTL**（控制实验），而跑不出 **NUG_PLR**（加入羽流抬升的实验）。

3.  **关于 `xmlchange`**:
    *   原脚本里有一行注释掉的 `./xmlchange CAM_CONFIG_OPTS="-phys cam6 -chem trop_mam4 ..."`。如果 `F2000climo` 默认配置不符合你的需求，你需要解开注释并修改。但通常 `F2000climo` 默认就是 CAM6 + MAM4，所以可以不动。

4.  **检查路径**:
    *   你的脚本里写的是 `setenv CIME_OUTPUT_ROOT /share/home/ywliu/lxyyy/scratch/runout`。请确认 `lxyyy` 是正确的目录名。

### 总结一下复现流程

1.  **跑通 CTL (控制实验)**: 直接用我给你的脚本，确保 Nudging 数据路径正确，跑通一年。这就是文章里的 **NUG_CTL**。
2.  **搞定代码**: 找到 plume-rise 相关的 Fortran 代码。
3.  **跑通 PLR (敏感性实验)**: 将代码放入 `SourceMods`，重新 build 并运行脚本。这就是文章里的 **NUG_PLR**。

祝你运行顺利！如果遇到报错，去 `RUNDIR` 下面看 `cesm.log` 或者 `atm.log`，通常里面会有详细的错误信息。加油！

---

### 1. 气象强迫数据 (Meteorological Forcing Data)

由于你做的是 **NUG (Nudged)** 实验，模型的大尺度环流（风场 U, V）需要被“按”在真实的历史气象场上。

*   **需要什么数据？**
    *   文章中明确提到使用的是 **MERRA-2 再分析资料**。
    *   你需要 **2018年** 的数据（因为文章重点是2018年的WE-CAN观测对比）。
    *   变量通常包括：`U`, `V`, `T` (温度), `Q` (湿度), `PS` (地表气压)。虽然文章说只 Nudge 了 U 和 V，但制作 Nudging 文件时通常是一套标准变量都在里面。

*   **去哪里找/下载？**
    *   **首选方案（服务器现成）：**
        你的脚本里有一行路径：
        `/share/home/minghuai/Liuym/DATA/MERRA2/CESM/0.9x1.25_32L/`
        **请立即去检查这个文件夹！**
        使用命令：`ls /share/home/minghuai/Liuym/DATA/MERRA2/CESM/0.9x1.25_32L/`
        看看里面有没有 `2018-xx-xx.nc` 这样的文件。如果师姐或组里以前跑过2018年的实验，直接用现成的最省事。
    *   **备选方案（自己下载）：**
        如果服务器上没有，你需要去 **NCAR RDA (Research Data Archive)** 或者 NASA 的 GES DISC 下载 MERRA-2 原始数据，然后使用 CESM 提供的工具（如 `ncl` 脚本）将其插值处理成 CESM 需要的网格格式（ne30 或者 f09）。
        *这对研一新生来说难度较大，如果服务器没有，建议先问师姐要“2018年的Nudging数据”。*

*   **数据放在哪里？**
    *   如果用服务器现成的，不用移动，直接在脚本里指过去。
    *   如果是你新下载/处理的，建议放在：`/share/home/ywliu/lxyyy/data/nudging/MERRA2_2018/`。

---

### 2. 排放数据 (Emission Data) —— ⚠️这是最核心的难点

这是复现这篇文章的重头戏。普通的 CESM 运行只需要“每月排放量”，但 **Freitas Plume-Rise 模型** 需要更详细的参数来计算烟羽能升多高。

*   **需要什么数据？**
    1.  **QFED 排放清单 (QFED Emissions):**
        文章提到：*"we generated emission files containing QFED BBA emissions of BC and POM."*
        默认的 CESM 使用的是 CMIP6 或 GFED 排放。为了复现，你需要 2018 年的 **QFED (Quick Fire Emissions Dataset)** 每日数据。
    2.  **火辐射功率 (FRP, Fire Radiative Power):**
        文章提到：*"Input for the plume-rise model... fire heat flux and active fire size... based on MODIS retrieved FRP values."*
        **这是关键！** 普通的排放文件里只有 `mass flux` (kg/m²/s)。你需要一个包含 **FRP** 变量的输入文件，或者修改排放文件把 FRP 加进去。Plume-rise 模块需要读取 FRP 来计算热浮力。
    3.  **火点日变化 (Diurnal Cycle):**
        文章提到使用了来自卫星反演的日变化曲线。这通常可能是一个硬编码在模型里的参数，或者是一个外部读取的数据文件。

*   **去哪里下载？**
    *   **NASA Earthdata Search**: 可以下载原始的 QFED 数据（通常是 NetCDF 格式）。
    *   但是，**你不能直接把下载的文件给 CESM 用**。你需要做“前处理” (Pre-processing)。你需要写 Python 或 NCL 脚本，把 QFED 数据及 FRP 数据，插值到你的模型网格（f09_f09），并重命名为 CESM 能识别的变量名（如 `bb_BC`, `bb_POM` 等）。

*   **数据放在哪里？**
    *   建议建立目录：`/share/home/ywliu/lxyyy/data/emissions/2018_QFED/`
    *   把处理好的 NetCDF 文件放进去。

---

### 3. 验证数据 (Validation Data) —— 可选，后期画图用

如果你跑完模型需要画图来证明你“复现成功”了，你需要文章里的观测数据来做对比。

*   **MISR Plume Height:** 用于验证烟羽高度（文章图2）。
*   **WE-CAN Aircraft Data:** 2018年西部的飞机观测数据（文章图5）。
*   **下载地址**: 文章末尾的 "Data Availability Statement" 通常会给链接，或者去 NASA LaRC / UCAR 的数据档案库搜。
*   **存放位置**: `/share/home/ywliu/lxyyy/obs_data/`

---

### 保姆级操作建议：你现在该做什么？

作为研一新生，不要试图一口气吃成胖子。请按以下顺序操作：

#### 第一阶段：先跑通 Nudging (使用默认排放)
不要先管 QFED 和 FRP，先确保你的模型能读入气象场跑起来。

1.  **检查 Nudging 数据**:
    ```bash
    cd /share/home/minghuai/Liuym/DATA/MERRA2/CESM/0.9x1.25_32L/
    ls *2018*
    ```
    *   **情况A**: 有一大堆 2018 的 nc 文件。 -> **恭喜你**，直接用。
    *   **情况B**: 没有。 -> **求助**。问师姐：“师姐，我想跑2018年的Nudging实验，服务器上有处理好的2018年MERRA2数据吗？”

2.  **创建列表文件**:
    如果找到了数据，你需要创建一个文本文件（比如 `filenames_2018.txt`），里面每一行写一个数据文件的绝对路径，按时间顺序排列。

#### 第二阶段：处理排放数据 (进阶)
等你跑通了第一阶段，再考虑这一步。

1.  你需要去下载 2018 年的 QFED 数据。
2.  你需要确认你拿到的源代码（Fortran文件）里，它是怎么读取 FRP 的？
    *   是读变量名 `FRP`？还是读 `fire_energy`？
    *   它是从哪个文件读？是 `cam_initfiles` 还是 `prescribed_aero_datpath`？
    *   **这一步需要先看代码，再准备数据**，否则你下载了数据也不知道怎么改变量名。

### 总结

**目前你只需要关注：**
`/share/home/ywliu/lxyyy/data/nudging/` (存放气象强迫数据)
`/share/home/ywliu/lxyyy/data/emissions/` (未来存放排放数据)

**立刻行动：**
去检查 `/share/home/minghuai/Liuym/DATA/MERRA2/CESM/0.9x1.25_32L/` 下面有没有 2018 年的文件。这是你复现 NUG 实验的第一块砖。
